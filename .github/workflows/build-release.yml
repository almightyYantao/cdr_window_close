name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # ===== æ„å»ºMinHook =====
    - name: Cache MinHook
      id: cache-minhook
      uses: actions/cache@v3
      with:
        path: minhook
        key: minhook-1.3.3

    - name: Download and Build MinHook
      if: steps.cache-minhook.outputs.cache-hit != 'true'
      run: |
        git clone https://github.com/TsudaKageyu/minhook.git
        cd minhook
        mkdir build
        cd build
        cmake .. -A x64
        cmake --build . --config Release
      shell: cmd

    - name: List MinHook build output
      run: |
        echo Listing entire MinHook build directory:
        dir /s /b minhook\build
      shell: cmd

    - name: Copy MinHook files
      run: |
        if not exist "GdiHook" mkdir GdiHook
        copy minhook\include\MinHook.h GdiHook\
        copy minhook\build\Release\minhook.x64.lib GdiHook\
      shell: cmd

    # ===== æ„å»ºGdiHook.dll =====
    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1

    - name: Build GdiHook.dll
      run: |
        cd GdiHook
        cl /LD /O2 /EHsc GdiHook.cpp /link /DLL /OUT:GdiHook.dll minhook.x64.lib gdi32.lib user32.lib
      shell: cmd

    # ===== æ„å»ºC#ç¨‹åº =====
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2

    - name: Restore NuGet packages
      run: nuget restore CorelDrawErrorMonitor.csproj -PackagesDirectory packages

    - name: Build with MSBuild
      run: msbuild CorelDrawErrorMonitor.csproj /p:Configuration=Release /p:Platform="Any CPU" /p:OutputPath=bin\Release\

    - name: List build output
      run: |
        echo Listing bin\Release directory:
        dir /s /b bin\Release
      shell: cmd

    - name: Create deployment package
      run: |
        mkdir deploy
        copy bin\Release\CorelDrawErrorMonitor.exe deploy\
        copy bin\Release\config.json deploy\
        copy bin\Release\Newtonsoft.Json.dll deploy\
        copy GdiHook\GdiHook.dll deploy\
        copy START.bat deploy\
        echo # CorelDRAW Error Monitor > deploy\README.txt
        echo. >> deploy\README.txt
        echo REQUIRES ADMINISTRATOR PRIVILEGES >> deploy\README.txt
        echo. >> deploy\README.txt
        echo 1. Right-click START.bat and select "Run as Administrator" >> deploy\README.txt
        echo 2. Check system tray for the icon >> deploy\README.txt
        echo 3. Open CorelDRAW with error files >> deploy\README.txt
        echo 4. Errors will be auto-dismissed >> deploy\README.txt
        echo. >> deploy\README.txt
        echo Edit config.json to add more dialog rules. >> deploy\README.txt
      shell: cmd

    - name: Create ZIP archive
      run: |
        Compress-Archive -Path deploy\* -DestinationPath CorelDRAW-Error-Monitor.zip
      shell: powershell

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: CorelDRAW-Error-Monitor
        path: CorelDRAW-Error-Monitor.zip

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        files: CorelDRAW-Error-Monitor.zip
        body: |
          ## CorelDRAW é”™è¯¯è‡ªåŠ¨å¿½ç•¥ç›‘æ§ç¨‹åº

          ### ğŸ¯ è¿™æ˜¯ä»€ä¹ˆ?
          ä¸€ä¸ªç‹¬ç«‹è¿è¡Œçš„Windowsç¨‹åº,è‡ªåŠ¨ç‚¹å‡»CorelDRAWé”™è¯¯å¯¹è¯æ¡†çš„"å¿½ç•¥"æŒ‰é’®ã€‚

          ### âœ¨ ä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½å¹¶è§£å‹ `CorelDRAW-Error-Monitor.zip`
          2. åŒå‡» `START.bat` å¯åŠ¨ç¨‹åº
          3. ç¨‹åºåœ¨ç³»ç»Ÿæ‰˜ç›˜è¿è¡Œ(æ—¶é’Ÿæ—è¾¹)
          4. æ‰“å¼€CorelDRAW,é”™è¯¯å¯¹è¯æ¡†ä¼šè‡ªåŠ¨å…³é—­
          5. é€€å‡º: å³é”®æ‰˜ç›˜å›¾æ ‡ â†’ Exit

          ### âœ… ç‰¹ç‚¹
          - ä¸éœ€è¦å®‰è£…,è§£å‹å³ç”¨
          - ä¸éœ€è¦ç®¡ç†å‘˜æƒé™
          - åœ¨ç³»ç»Ÿæ‰˜ç›˜åå°è¿è¡Œ
          - åŒå‡»å¯åŠ¨,å³é”®é€€å‡º
          - è‡ªåŠ¨æ£€æµ‹å¹¶å¤„ç†é”™è¯¯å¯¹è¯æ¡†

          ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
          - Windows 7/8/10/11
          - .NET Framework 4.7.2æˆ–æ›´é«˜ç‰ˆæœ¬

          ### ğŸ” éªŒè¯è¿è¡Œ
          - æŸ¥çœ‹ç³»ç»Ÿæ‰˜ç›˜(æ—¶é’Ÿæ—è¾¹)æ˜¯å¦æœ‰ç¨‹åºå›¾æ ‡
          - åŒå‡»æ‰˜ç›˜å›¾æ ‡å¯ä»¥çœ‹åˆ°"å…³äº"ä¿¡æ¯
          - å†æ¬¡è¿è¡ŒSTART.batä¼šæç¤º"Already Running"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
